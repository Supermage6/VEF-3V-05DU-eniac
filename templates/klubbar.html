{% extends "base.html" %}
{% block title %}KLÚBBAR{% endblock %}
{% block content %}
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
    <div>
      <h1>Klúbbar</h1>
      {% for i in k %}
        <button class="accordion">{{ i.nafn }}</button>
        <div class="panel">
          <p>Stofa: {{ i.stofa }}</p>
          <p>Formaður: {{ i.formadur }}</p>
          <p>{{ i.desc }}</p>
        </div>
      {% endfor %}
      {% if is_student or is_admin %}
        <a class="btn" href="{{ url_for('klubbar_propose') }}">Stofna klúbb +</a>
      {% endif %}
    </div>
    <div>
      <h1>Stofur</h1>
      <div id="map-box" style="position: relative; border: 1px solid black; width: 600px; background:#fff;">
        <img id="floor-map" src="{{ url_for('static', filename='floor-2.png') }}" alt="Floor plan" style="max-width:100%; height:auto; display:block;"/>
      </div>
      <button type="button">hæð 2</button> <button type="button">hæð 3</button>
    </div>
  </div>

  {% if is_admin %}
    <a class="admin-edit-btn" href="{{ url_for('klubbar_edit') }}" title="Edit clubs">Edit</a>
  {% endif %}

<script id="page-data" type="application/json">
  {{ {'clubs': (k or []), 'is_admin': is_admin} | tojson }}
</script>
<script>
  const acc = document.getElementsByClassName("accordion");
  for (let i = 0; i < acc.length; i++) {
    acc[i].addEventListener("click", function () {
      this.classList.toggle("active");
      const panel = this.nextElementSibling;
      const willOpen = !panel.classList.contains("open");
      panel.classList.toggle("open");
      if (willOpen) {
        panel.style.maxHeight = panel.scrollHeight + "px";
      } else {
        panel.style.maxHeight = null;
      }
    });
  }

  // floor map + hotspots overlay
  const PAGE_DATA = JSON.parse(document.getElementById('page-data').textContent || '{}');
  const CLUBS = PAGE_DATA.clubs || [];
  const IS_ADMIN = Boolean(PAGE_DATA.is_admin);
  
  (function() {
    const mapEl = document.getElementById('floor-map');
    const mapBox = document.getElementById('map-box');
    if (!mapEl || !mapBox) return;
    const btn1 = mapBox.nextElementSibling;
    const btn2 = btn1 ? btn1.nextElementSibling : null;
      const floorSrc = {
        '2': "{{ url_for('static', filename='floor-2.png') }}",
        '3': "{{ url_for('static', filename='floor-3.png') }}",
      };
    const Y_OFFSET = { '2': 3, '3': 3 };
    let hotspotsData = null;
    let currentFloor = '2';
    let editMode = false;

    function saveMap() {
      if (!IS_ADMIN || !hotspotsData) return;
      fetch("{{ url_for('admin_map_save') }}", {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(hotspotsData)
      }).catch(() => {});
    }
    function clearHotspots() { mapBox.querySelectorAll('.hotspot').forEach(n => n.remove()); }
    function renderHotspots(floor) {
      clearHotspots();
      if (!hotspotsData || !hotspotsData.floors) return;
      const items = hotspotsData.floors[floor] || [];
      items.forEach(item => {
        const el = document.createElement('div');
        const roomCode = (item.room || '').toString();
        const club = CLUBS.find(c => (c.stofa || '').toString().trim().toLowerCase() === roomCode.trim().toLowerCase());
        el.className = 'hotspot' + (club ? ' assigned' : ' unassigned');
        const y = (item.y || 0) + (Y_OFFSET[floor] || 0);
        el.style.left = (item.x || 0) + '%';
        el.style.top = y + '%';
        el.setAttribute('data-label', (item.room ? ('Stofa ' + item.room + ' - ') : '') + (club ? (club.nafn || '') : 'Óúthlutað'));
        el.title = club ? (club.nafn || '') : '';
        mapBox.appendChild(el);

        el.addEventListener('pointerdown', (ev) => {
          if (!IS_ADMIN || !editMode) return;
          el.setPointerCapture(ev.pointerId);
          const roomIdx = (hotspotsData.floors[currentFloor] || []).findIndex(r => (r.room || '').toString() === roomCode);
          const onMove = (e) => {
            const rect = mapBox.getBoundingClientRect();
            let nx = ((e.clientX - rect.left) / rect.width) * 100;
            let ny = ((e.clientY - rect.top) / rect.height) * 100;
            nx = Math.max(0, Math.min(100, nx));
            ny = Math.max(0, Math.min(100, ny));
            el.style.left = nx + '%';
            el.style.top = ny + '%';
            if (roomIdx >= 0) {
              hotspotsData.floors[currentFloor][roomIdx].x = parseFloat(nx.toFixed(2));
              hotspotsData.floors[currentFloor][roomIdx].y = parseFloat((ny - (Y_OFFSET[currentFloor] || 0)).toFixed(2));
            }
          };
          const onUp = () => {
            el.releasePointerCapture(ev.pointerId);
            window.removeEventListener('pointermove', onMove);
            window.removeEventListener('pointerup', onUp);
          };
          window.addEventListener('pointermove', onMove);
          window.addEventListener('pointerup', onUp);
        });
      });
    }
    function setFloor(n) {
      currentFloor = (n in floorSrc) ? n : '2';
      mapEl.src = floorSrc[currentFloor];
      renderHotspots(currentFloor);
    }
    if (btn1 && btn1.tagName === 'BUTTON') btn1.addEventListener('click', () => setFloor('2'));
    if (btn2 && btn2.tagName === 'BUTTON') btn2.addEventListener('click', () => setFloor('3'));
    document.addEventListener('keydown', (e) => {
      if (!IS_ADMIN) return;
      if (e.key === 'e' || e.key === 'E') { editMode = !editMode; }
      else if (e.key === 's' || e.key === 'S') { saveMap(); }
    });
    fetch("{{ url_for('static', filename='map_rooms.json') }}")
      .then(r => r.json())
      .then(data => { hotspotsData = data; renderHotspots(currentFloor); })
      .catch(() => {});
  })();
</script>
{% endblock %}
