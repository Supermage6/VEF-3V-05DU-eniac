<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"/>
  <title>{% block title %} ENIAC {% endblock %}</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" defer></script>
</head>
<body>
  <header>
    <div class="brand"><img class="brand-logo" src="{{ url_for('static', filename='logo.png') }}" alt="ENIAC logo"/>ENIAC</div>
    <div class="header-actions">
      <nav aria-label="Main">
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('klubbar') }}">Clubs</a>
        <a href="{{ url_for('dagskra') }}">Schedule</a>
        {% if session.get('role') == 'admin' %}
          <a class="btn" href="{{ url_for('info') }}" title="Info">Info</a>
        {% endif %}
      </nav>
      {% block header_auth %}
        <span class="role-badge" aria-live="polite">{{ 'Admin' if session.get('role') == 'admin' else ('Student' if session.get('user') else 'Guest') }}</span>

        {% if session.get('user') %}
          <div class="profile-wrap">
            <button id="profileBtn" class="profile-pill" aria-haspopup="menu" aria-expanded="false" title="{{ session.get('user') }}">{{ (session.get('user') or '?')[:1]|upper }}</button>
                <div id="profileMenu" class="profile-menu" role="menu" aria-label="Profile menu">
                  <form method="post" action="{{ url_for('logout') }}">
                    <button class="profile-item" type="submit" role="menuitem">Log out</button>
                  </form>
                </div>
          </div>
        {% else %}
          <a id="loginBtn" class="btn" href="#login" aria-label="Log in">Log in</a>
        {% endif %}
      {% endblock %}
    </div>
  </header>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" aria-hidden="true">

    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-dialog" role="dialog" aria-labelledby="loginTitle" aria-modal="true">
      <div class="modal-header">
        <h2 id="loginTitle" class="modal-title">Log in</h2>
        <button class="modal-close" type="button" aria-label="Close" data-close="true">×</button>
      </div>
      <form method="post" action="{{ url_for('login') }}">
        <label class="field">
          <span>Username</span>
          <input name="username" type="text" autocomplete="username" required>
        </label>
        <label class="field">
          <span>Password</span>
          <input name="password" type="password" autocomplete="current-password" required>
        </label>
        <div class="modal-actions">
          <a class="btn secondary" href="{{ url_for('register') }}">Create user</a>
          <button class="btn secondary" type="button" data-close="true">Cancel</button>
          <button class="btn" type="submit">Log in</button>
        </div>
      </form>
    </div>
  </div>

  {% block content %}{% endblock %}

  <footer>© 2025 ENIAC</footer>

  <script>
    (function(){
        const openBtn = document.getElementById('loginBtn');
        const modal = document.getElementById('loginModal');
        const profileBtn = document.getElementById('profileBtn');
        const profileWrap = profileBtn ? profileBtn.closest('.profile-wrap') : null;
          let lastFocused = null;

      function openModal(e){
        if (e) e.preventDefault();
        lastFocused = document.activeElement;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        const user = modal.querySelector('input[name="username"]');
        if (user) user.focus();
      }
      function closeModal(){
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
      }
      if (openBtn) openBtn.addEventListener('click', openModal);
      // Also support any element with data-open-login="true"
      document.querySelectorAll('[data-open-login]')
        .forEach(el => el.addEventListener('click', openModal));
      modal.addEventListener('click', (e)=>{
        if (e.target.dataset.close === 'true') closeModal();
      });
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') {
          if (modal.classList.contains('open')) closeModal();
          if (profileWrap && profileWrap.classList.contains('open')) toggleProfile(false);
        }
      });

      function toggleProfile(forceState){
        if (!profileWrap) return;
        const isOpen = typeof forceState === 'boolean' ? forceState : !profileWrap.classList.contains('open');
        profileWrap.classList.toggle('open', isOpen);
        profileBtn.setAttribute('aria-expanded', String(isOpen));
      }
        if (profileBtn) {
          profileBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            toggleProfile();
          });
          document.addEventListener('click', (e)=>{
            if (!profileWrap.contains(e.target)) toggleProfile(false);
          });
        }
        })();

    (function() {
    var s = document.createElement('script');s.type='text/javascript';s.async=true;s.id='lsInitScript';
    s.src='https://app.livesupporti.com/js/clientAsync.js?acc=9de0cc4f-e585-46b5-bf3a-979be2362637&skin=Air';
    var scr=document.getElementsByTagName('script')[0];scr.parentNode.appendChild(s, scr);
    })();
  </script>
  <script>
    // Animate-on-scroll using IntersectionObserver + anime.js (enter and exit)
    (function(){
      const ready = () => {
        const items = document.querySelectorAll('[data-animate]');
        if (!items.length) return;

        function animateIn(el) {
          const kind = el.getAttribute('data-animate');
          const delay = parseInt(el.getAttribute('data-delay') || '0', 10);
          el.classList.remove('will-animate');
          if (window.anime) {
            anime.remove(el);
            if (kind === 'fade-up') {
              anime({ targets: el, opacity: [0,1], translateY: [16,0], duration: 600, easing: 'easeOutQuad', delay });
            } else if (kind === 'fade-in') {
              anime({ targets: el, opacity: [0,1], duration: 500, easing: 'easeOutQuad', delay });
            } else if (kind === 'scale-in') {
              anime({ targets: el, opacity: [0,1], scale: [0.96,1], duration: 500, easing: 'easeOutQuad', delay });
            } else {
              anime({ targets: el, opacity: [0,1], duration: 500, easing: 'easeOutQuad', delay });
            }
          } else {
            el.style.opacity = 1;
            el.style.transform = 'none';
          }
        }

        function animateOut(el) {
          const kind = el.getAttribute('data-animate');
          if (window.anime) {
            anime.remove(el);
            if (kind === 'fade-up') {
              anime({ targets: el, opacity: [1,0], translateY: [0,16], duration: 400, easing: 'easeOutQuad', complete: ()=>{ el.classList.add('will-animate'); } });
            } else if (kind === 'fade-in' || kind === 'scale-in') {
              anime({ targets: el, opacity: [1,0], duration: 350, easing: 'easeOutQuad', complete: ()=>{ el.classList.add('will-animate'); el.style.transform = ''; } });
            } else {
              anime({ targets: el, opacity: [1,0], duration: 350, easing: 'easeOutQuad', complete: ()=>{ el.classList.add('will-animate'); } });
            }
          } else {
            el.classList.add('will-animate');
          }
        }

        const io = new IntersectionObserver((entries)=>{
          entries.forEach(entry => {
            const el = entry.target;
            const visible = entry.isIntersecting && entry.intersectionRatio > 0.05;
            if (visible) {
              if (!el.__visible) {
                el.__visible = true;
                animateIn(el);
              }
            } else {
              if (el.__visible) {
                el.__visible = false;
                animateOut(el);
              }
            }
          });
        }, { rootMargin: '0px 0px -10% 0px', threshold: [0, 0.05, 0.15] });

        items.forEach((el) => {
          // Stagger child list items if requested
          if (el.hasAttribute('data-stagger-children')) {
            const kids = el.querySelectorAll(el.getAttribute('data-stagger-children'));
            kids.forEach((child, idx) => {
              child.classList.add('will-animate');
              child.setAttribute('data-animate', child.getAttribute('data-animate') || 'fade-up');
              child.setAttribute('data-delay', String(idx * 80));
              io.observe(child);
            });
          }
          el.classList.add('will-animate');
          io.observe(el);
        });
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ready);
      } else {
        ready();
      }
    })();
  </script>
</body>
</html>


