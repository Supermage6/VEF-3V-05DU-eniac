<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="static/styles.css"/>
  <title>{% block title %} ENIAC {% endblock %}</title>
</head>
<body>
  <header>
    <div class="brand">ENIAC</div>
    <div class="header-actions">
      <nav aria-label="Main">
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('klubbar') }}">Clubs</a>
        <a href="{{ url_for('dagskra') }}">Schedule</a>
      </nav>

      <span class="role-badge" aria-live="polite">{{ 'Admin' if session.get('role') == 'admin' else ('Student' if session.get('user') else 'Guest') }}</span>

      {% if session.get('user') %}
        <div class="profile-wrap">
          <button id="profileBtn" class="profile-pill" aria-haspopup="menu" aria-expanded="false" title="{{ session.get('display_name', session['user']) }}">{{ session.get('display_name', session['user'])[:3]|upper }}</button>
          <div id="profileMenu" class="profile-menu" role="menu" aria-label="Profile menu">
            <form method="post" action="{{ url_for('logout') }}">
              <button class="profile-item" type="submit" role="menuitem">Log out</button>
            </form>
          </div>
        </div>
      {% else %}
        <a id="loginBtn" class="btn" href="#login" aria-label="Log in">Log in</a>
      {% endif %}
    </div>
  </header>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" aria-hidden="true">

    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-dialog" role="dialog" aria-labelledby="loginTitle" aria-modal="true">
      <div class="modal-header">
        <h2 id="loginTitle" class="modal-title">Log in</h2>
        <button class="modal-close" type="button" aria-label="Close" data-close="true">×</button>
      </div>
      <form method="post" action="{{ url_for('login') }}">
        <label class="field">
          <span>Username</span>
          <input name="username" type="text" autocomplete="username" required>
        </label>
        <label class="field">
          <span>Password</span>
          <input name="password" type="password" autocomplete="current-password" required>
        </label>
        <div class="modal-actions">
          <button class="btn secondary" type="button" data-close="true">Cancel</button>
          <button class="btn" type="submit">Log in</button>
        </div>
      </form>
    </div>
  </div>

  {% block content %}{% endblock %}

  <footer>© 2025 ENIAC</footer>

  <script>
    (function(){
      const openBtn = document.getElementById('loginBtn');
      const modal = document.getElementById('loginModal');
      const profileBtn = document.getElementById('profileBtn');
      const profileWrap = profileBtn ? profileBtn.closest('.profile-wrap') : null;
      let lastFocused = null;

      function openModal(e){
        if (e) e.preventDefault();
        lastFocused = document.activeElement;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        const user = modal.querySelector('input[name="username"]');
        if (user) user.focus();
      }
      function closeModal(){
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
      }
      if (openBtn) openBtn.addEventListener('click', openModal);
      // Also support any element with data-open-login="true"
      document.querySelectorAll('[data-open-login]')
        .forEach(el => el.addEventListener('click', openModal));
      modal.addEventListener('click', (e)=>{
        if (e.target.dataset.close === 'true') closeModal();
      });
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') {
          if (modal.classList.contains('open')) closeModal();
          if (profileWrap && profileWrap.classList.contains('open')) toggleProfile(false);
        }
      });

      function toggleProfile(forceState){
        if (!profileWrap) return;
        const isOpen = typeof forceState === 'boolean' ? forceState : !profileWrap.classList.contains('open');
        profileWrap.classList.toggle('open', isOpen);
        profileBtn.setAttribute('aria-expanded', String(isOpen));
      }
      if (profileBtn) {
        profileBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          toggleProfile();
        });
        document.addEventListener('click', (e)=>{
          if (!profileWrap.contains(e.target)) toggleProfile(false);
        });
      }
    })();
  </script>
</body>
</html>


