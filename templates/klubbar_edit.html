{% extends "base.html" %}
{% block title %}Edit Clubs{% endblock %}
{% block header_auth %}
  <div class="admin-user-tools">
    <form class="create-user-inline" method="post" action="{{ url_for('admin_create_user') }}">
      <input type="text" name="username" placeholder="New username" required style="padding:6px 10px; border:1px solid #ccc; border-radius:8px;">
      <input type="password" name="password" placeholder="Password" required style="padding:6px 10px; border:1px solid #ccc; border-radius:8px;">
      <select name="role" style="padding:6px 10px; border:1px solid #ccc; border-radius:8px;">
        <option value="student">Student</option>
        <option value="admin">Admin</option>
      </select>
      <button class="btn" type="submit">Create user</button>
    </form>
    <form class="remove-user-inline" method="post" action="{{ url_for('admin_remove_user') }}">
      <input type="text" name="username" placeholder="Username to remove" required style="padding:6px 10px; border:1px solid #ccc; border-radius:8px;">
      <button class="btn danger" type="submit" onclick="return confirm('Remove this user?');">Remove user</button>
    </form>
  </div>
{% endblock %}
{% block content %}
  <h1>Edit Clubs</h1>
  <form method="post" action="{{ url_for('klubbar_edit') }}" style="display:grid; gap:16px; max-width:720px;">
    {% for i in range(k|length) %}
      {% set c = k[i] %}
      <fieldset style="border:1px solid #ddd; border-radius:8px; padding:12px;">
        <legend>Club #{{ i + 1 }}</legend>
        <div class="field">
          <label>
            <div>Name</div>
            <input type="text" name="name_{{ i }}" value="{{ c.nafn }}" required />
          </label>
        </div>
        <div class="field">
          <label>
            <div>Room (stofa)</div>
            <input type="text" name="stofa_{{ i }}" value="{{ c.stofa }}" />
          </label>
        </div>
        <div class="field">
          <label>
            <div>Description</div>
            <textarea name="desc_{{ i }}" rows="3" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">{{ c.desc }}</textarea>
          </label>
        </div>
        <div style="color:#666; font-size:.9rem;">
          Room: {{ c.stofa }} • Leader: {{ c.formadur }}
        </div>
      </fieldset>
    {% endfor %}
    <div style="display:flex; gap:10px;">
      <button class="btn" type="submit">Save changes</button>
      <a class="btn secondary" href="{{ url_for('klubbar') }}">Cancel</a>
    </div>
  </form>

  <section style="margin-top:24px;">
    <h2>Map Editor</h2>
    <p style="color:#555; margin-top:0;">Drag the dots to their correct room locations. Switch floors as needed and click Save.</p>
    <div id="map-box" style="position: relative; border: 1px solid #000; width: 600px; background:#fff;">
      <img id="floor-map" src="{{ url_for('static', filename='floor-2.png') }}" alt="Floor plan" style="max-width:100%; height:auto; display:block;"/>
    </div>
    <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
      <button type="button" class="btn secondary" data-floor="2" aria-pressed="true">hæð 2</button>
      <button type="button" class="btn secondary" data-floor="3" aria-pressed="false">hæð 3</button>
      <button type="button" class="btn" id="save-map">Save map</button>
      <span id="save-status" style="margin-left:8px; color:#666; font-size:.9rem;"></span>
    </div>
  </section>

  <script>
    // Map editor (admin)
    (function() {
      const CLUBS = {{ k | tojson }};
      const mapEl = document.getElementById('floor-map');
      const mapBox = document.getElementById('map-box');
      const saveBtn = document.getElementById('save-map');
      const saveStatus = document.getElementById('save-status');
      if (!mapEl || !mapBox || !saveBtn) return;

      const floorButtons = document.querySelectorAll('[data-floor]');
      const floorSrc = {
        '2': "{{ url_for('static', filename='floor-2.png') }}",
        '3': "{{ url_for('static', filename='floor-3.png') }}",
      };
      // Vertical nudge for visual alignment
      const Y_OFFSET = { '2': 3, '3': 3 };

      let data = null; // map_rooms.json contents
      let currentFloor = '2';
      let dirty = false;

      function setDirty(val) {
        dirty = val;
        saveBtn.disabled = !dirty;
        saveStatus.textContent = dirty ? 'Unsaved changes' : '';
      }

      function clearHotspots() {
        mapBox.querySelectorAll('.hotspot').forEach(n => n.remove());
      }

      function clubForRoom(roomCode) {
        const rc = (roomCode || '').toString().trim().toLowerCase();
        return CLUBS.find(c => (c.stofa || '').toString().trim().toLowerCase() === rc) || null;
      }

      function renderHotspots(floor) {
        clearHotspots();
        if (!data || !data.floors) return;
        const items = data.floors[floor] || [];
        items.forEach(item => {
          const el = document.createElement('div');
          const roomCode = (item.room || '').toString();
          const club = clubForRoom(roomCode);
          el.className = 'hotspot' + (club ? ' assigned' : ' unassigned');
          const y = (item.y || 0) + (Y_OFFSET[floor] || 0);
          el.style.left = (item.x || 0) + '%';
          el.style.top = y + '%';
          el.setAttribute('data-label', (item.room ? ('Stofa ' + item.room + ' - ') : '') + (club ? (club.nafn || '') : 'Óúthlutað'));
          el.title = club ? (club.nafn || '') : '';
          mapBox.appendChild(el);

          // Dragging
          el.addEventListener('pointerdown', (ev) => {
            el.setPointerCapture(ev.pointerId);
            const list = data.floors[currentFloor] || [];
            const idx = list.findIndex(r => (r.room || '').toString() === roomCode);
            const onMove = (e) => {
              const rect = mapBox.getBoundingClientRect();
              let nx = ((e.clientX - rect.left) / rect.width) * 100;
              let ny = ((e.clientY - rect.top) / rect.height) * 100;
              nx = Math.max(0, Math.min(100, nx));
              ny = Math.max(0, Math.min(100, ny));
              el.style.left = nx + '%';
              el.style.top = ny + '%';
              if (idx >= 0) {
                list[idx].x = parseFloat(nx.toFixed(2));
                list[idx].y = parseFloat((ny - (Y_OFFSET[currentFloor] || 0)).toFixed(2));
                setDirty(true);
              }
            };
            const onUp = () => {
              el.releasePointerCapture(ev.pointerId);
              window.removeEventListener('pointermove', onMove);
              window.removeEventListener('pointerup', onUp);
            };
            window.addEventListener('pointermove', onMove);
            window.addEventListener('pointerup', onUp);
          });
        });
      }

      function setFloor(n) {
        currentFloor = (n in floorSrc) ? n : '2';
        mapEl.src = floorSrc[currentFloor];
        renderHotspots(currentFloor);
        floorButtons.forEach(btn => btn.setAttribute('aria-pressed', btn.dataset.floor === currentFloor ? 'true' : 'false'));
      }

      floorButtons.forEach(btn => btn.addEventListener('click', () => setFloor(btn.dataset.floor)));

      saveBtn.addEventListener('click', () => {
        if (!data) return;
        saveBtn.disabled = true;
        saveStatus.textContent = 'Saving…';
        fetch("{{ url_for('admin_map_save') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).then(r => {
          if (r.ok) {
            setDirty(false);
            saveStatus.textContent = 'Saved';
            setTimeout(() => saveStatus.textContent = '', 1500);
          } else {
            saveStatus.textContent = 'Save failed';
          }
        }).catch(() => { saveStatus.textContent = 'Save failed'; });
      });

      // Load existing positions
      fetch("{{ url_for('static', filename='map_rooms.json') }}")
        .then(r => r.json())
        .then(json => { data = json; renderHotspots(currentFloor); })
        .catch(() => {});
    })();
  </script>
{% endblock %}
